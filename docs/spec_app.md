# spec_app — UI / 表示仕様

## 目的
宿泊旅行統計調査の「延べ宿泊者数（全体/国内/海外）」を、地域×月次で表・グラフ表示し、Excelとして持ち出せるようにする。

## 画面
- Streamlit単一ページ（`app.py`）

## 入力データ
- SQLite: `data/market_stats.sqlite`
- メタ: `data/meta.json`（存在する場合のみ表示）

## 表示要素

### ヘッダ
- タイトル：宿泊旅行統計調査：延べ宿泊者数（全体 / 国内 / 海外）
- メタ情報（任意、`meta.json` がある場合）
  - 最終取得日時（UTC）
  - 範囲（min_ym〜max_ym）
  - rows

### UIコントロール
- 地域区分：都道府県 / 地方
- 地域
  - 都道府県：全国（pref_code=00）＋都道府県（01〜47）
  - 地方：定義済み地域ブロック（下記「地方定義」）
  - 地方選択時は対象都道府県コードを表示
- 期間
  - 開始（年）/ 開始（月）
  - 終了（年）/ 終了（月）
  - 月は `01`〜`12` から選択
  - デフォルトは「終了=最新月、開始=直近36か月相当」
  - 範囲外の年月は利用可能範囲に補正する
  - 開始>終了になった場合は自動で入れ替える
- 表示モード：表＋グラフ / 表のみ / グラフのみ
- チャートモード
  - 時系列（積み上げ縦棒：国内＋海外）
  - 年別（同月比較：全体/国内/海外）
- 値の種類（グラフ共通）
  - 月次 `※デフォルト`
  - 年計推移（表記月起点・直近12か月ローリング）
  - 年計推移時は、各表記月について当月を含む直近12か月を合算する
  - 年計推移時に12か月未満の先頭データは表示しない（0埋めしない）
- 時系列の表示内容（時系列モード時のみ）
  - 国内+海外（積み上げ）`※デフォルト`
  - 全体
  - 国内
  - 海外
- 年別同月比較の指標（年別モード時のみ）
  - 全体 / 国内 / 海外
- 年別同月比較の対象年（年別モード時のみ）
  - 複数選択可
  - 初期値は選択地域で利用可能な最新4年（4年未満なら全件）

### 地方定義
- 北海道: 01
- 東北: 02,03,04,05,06,07
- 関東: 08,09,10,11,12,13,14
- 中部: 15,16,17,18,19,20,21,22,23
- 近畿（関西）: 24,25,26,27,28,29,30
- 中国: 31,32,33,34,35
- 四国: 36,37,38,39
- 九州・沖縄: 40,41,42,43,44,45,46,47

### 地方選択時の集計
- 選択した地方に属する都道府県（01〜47）の `total` / `jp` / `foreign` を `ym` 単位で合算する
- 全国（00）は地方集計には含めない

### 表
- 列：年月 / 全体 / 国内 / 海外
- ym昇順
- 地域区分・地域・期間フィルタを反映する

### グラフ（画面内）
- Altairの縦棒グラフ
- 表示幅は `use_container_width=True`
- ツールチップを表示する（年月/年/月/値、必要に応じて区分）

#### モードA：時系列（積み上げ縦棒：国内＋海外）
- `国内+海外（積み上げ）`：`jp` と `foreign` の積み上げ縦棒
- `全体` / `国内` / `海外`：単一系列の縦棒
- 値の種類が `年計推移` の場合、`jp` / `foreign` / `total` をそれぞれ12か月ローリング化して表示する
- 地域区分・地域・期間フィルタを反映する

#### モードB：年別（同月比較：全体/国内/海外）
- x：月（`01`〜`12`、昇順固定）
- 系列：年（color）
- 表示形：同月内で年ごとに並ぶグループ化縦棒（積み上げなし）
- 指標切替：全体/国内/海外（単一指標）
- 値の種類が `年計推移` の場合、選択指標を12か月ローリング化して同月比較する
- データ範囲は「選択地域の全期間」を使用し、開始/終了の期間指定では絞り込まない
- 全期間データに対して、選択年のみを表示する

### エクスポート
- ボタン：`Excelダウンロード（データ＋グラフ）`
- ファイル名：`market_stats_{scope}_{ym_from}_{ym_to}.xlsx`（scopeは安全文字へ正規化）
- 出力対象
  - 表示中の表データ（地域区分・地域・期間適用後）
  - `charts` シートの時系列・年別同月比較は、画面の `値の種類（月次/年計推移）` を反映する
  - 年別同月比較の生成には選択地域の全期間データを使用
- ブック構成
  - `data` シート：`年月 / 地域コード / 地域名 / 全体 / 国内 / 海外`
  - `charts` シート：Excelネイティブ棒グラフ2件（時系列 / 年別同月比較）
- Excelグラフ実装上の挙動
  - 2チャートで軸IDを分離
  - 凡例は右配置・非オーバーレイ
  - 補助表の行範囲が重ならないよう年別開始行を動的決定
  - 補助表重なり検知のガードを持つ

### データ欠損時の挙動
- `data/market_stats.sqlite` が無い、または読み込み結果が空の場合：
  - エラーメッセージを表示し、更新スクリプト実行を促す
  - アプリは例外で落とさない
- 地域区分/地域に対応するデータが空の場合：
  - エラーメッセージを表示して処理を中断する

### 出典表示
- 画面下部に固定で出典を表示（例：観光庁「宿泊旅行統計調査」）

## 非目標（MVPではやらない）
- ピボットの完全再現（複数軸の複雑な集計）
- CSV/画像などの追加出力フォーマット
- 認証/権限（public想定）
