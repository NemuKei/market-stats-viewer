# Thread Log — market-stats-viewer（2026-02-06）

## 0) このスレッドの唯一の正（anchor_zip）

* anchor_zip: `market-stats-viewer_20260206_1723_main_0de6ead_full.zip`

## 1) 目的（このスレッドでやること）

* 宿泊旅行統計調査（観光庁の推移表Excel）を、手作業Excel集計から脱却し

  * 自動取得 → 正規化（RAW）→ SQLite保存 → Streamlitで「表＋グラフ」閲覧
  * GitHub Actionsで定期更新（public / 無料運用前提）
* 併せて、運用・共有の最低限（START_HERE / AGENTS / spec / decision / templates / make_release_zip）を整備する

## 2) 実施内容（実装・運用整備）

### 2-1. リポジトリ最小構成の確立

* `START_HERE.md` / `AGENTS.md` / `docs/spec_*.md` / `docs/decision_log.md` / `docs/templates/*` を整備
* `scripts/` に更新処理を集約し、`app.py` は表示（表・グラフ）中心にする方針で進行

### 2-2. 共有用ZIP（make_release_zip.py）の整備

* 事象：`scripts/` がZIPに入らない問題が発生
* 原因：

  * `git_only`（git追跡ファイルのみ対象）運用と未追跡/未追加の混同
  * さらに include パターンが `fnmatch` と噛み合わず、`scripts/**/*` が `scripts/update_data.py`（直下）にマッチしない
* 対応：

  * include を `scripts/**` / `docs/**` に寄せて、直下ファイルも確実に同梱されるよう修正
  * `MANIFEST.txt` を確認しながら同梱漏れの切り分けを実施

### 2-3. Actions実行形態（import破綻）の修正

* 事象：`python scripts/update_data.py` 実行形態だと import が壊れる可能性（`ModuleNotFoundError` 想定）があった
* 対応：

  * `scripts/__init__.py` を追加してパッケージ化
  * 実行コマンドを `python -m scripts.update_data` に統一（workflow / README / appの案内も整合）
  * `update_data.py` 側は相対 import + フォールバックでローカル実行にも耐える形に調整

### 2-4. 更新パイプラインのMVP実装

* `scripts/update_data.py`：

  * 観光庁ページから推移表Excelリンク検出 → DL → openpyxlで読み込み → 3シート（`1-2/2-2/3-2`）をパース
  * SQLite（`data/market_stats.sqlite`）と `data/meta.json` を生成/更新
* `scripts/parse_ts_table.py`：

  * 和暦年＋月ヘッダから年月（YYYY-MM）列を構築
  * 都道府県行を抽出して縦持ち→wide化（`total/jp/foreign`）
  * 全国（`00`）は **01〜47の合算**で生成する方針で実装

### 2-5. 表示（Streamlit）のMVP実装

* `app.py`：

  * 都道府県（全国含む）フィルタ、期間フィルタ、表示モード（表/グラフ）で閲覧
  * データ欠損時は落とさずに更新コマンド（`python -m scripts.update_data`）を案内

## 3) 発生した問題と対処ログ（重要）

* ZIP同梱漏れ：

  * `git_only` 前提・未追跡ファイル混入・`fnmatch` パターン不一致が原因として特定し、include修正で解消
* 文字化け（`?` 置換）：

  * 特定ファイル（例：`START_HERE.md` / `docs/spec_app.md`）が `?` に置換されたASCIIになったケースが発生
  * Markdownフェンス未閉鎖なども併発し、手動貼り替え（UTF-8）で復旧する流れを採用

## 4) このスレッドで作った/更新した成果物（代表）

* 運用：

  * `START_HERE.md`, `AGENTS.md`
  * `docs/spec_app.md`, `docs/spec_data.md`, `docs/spec_update_pipeline.md`
  * `docs/decision_log.md`, `docs/templates/*`
* 実装：

  * `scripts/update_data.py`, `scripts/parse_ts_table.py`, `scripts/__init__.py`
  * `.github/workflows/update_data.yml`
  * `make_release_zip.py`

## 5) 未完（次スレでやること候補）

1. Phase2（一致検証）：推移表（例：`001912060.xlsx`）と機械取得結果が一致するかの最小検証（全国/東京/大阪×数点）を仕組み化
2. 取得失敗時のフォールバック方針：HTML構造変更でリンク検出失敗した場合の手動URL指定等（spec追記が必要）
3. 文字化け再発防止：docs更新時の `?` 検知（grep/Select-String）を運用チェックに追加するか検討
4. README整形（コードフェンス閉鎖含む）を最終確定し、公開時の体裁を整える
